<!DOCTYPE html>
<html>
<head>
    <title>Near Me</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <form action="/outlets">
        <label for="brandSelect">Choose a brand:</label>
        <!-- <input type="text" name="searchWord" placeholder="Find this near me"> -->
        <select name="brand" id="brandSelect">
            <option value="">--Please choose an option--</option>
            <option value="kfc">KFC</option>
            <option value="mcd">McDonalds</option>
            <option value="bgk">Burger King</option>
        </select>

        <input type="submit" value="Go!">
    </form>
    <p id="locationStatus">Your location: </p>

    <h3>Results</h3>
    <div id="outletResults"></div>
    <script>
        let currentLatitude = null;
        let currentLongitude = null;

        function geoGetCurrentLocation() {
            const status = document.querySelector("#locationStatus");

            function success(pos) {
                currentLatitude = pos.coords.latitude;
                currentLongitude = pos.coords.longitude;
                status.textContent += currentLatitude + " " + currentLongitude;
            }

            function error() {
                status.textContent += "Error (unable to retrieve)";
            }

            if (!navigator.geolocation) {
                status.textContent += "Error (geolocation not supported)";
            } else {
                console.log('Trying to get location');
                navigator.geolocation.getCurrentPosition(success, error);
            }
        }

        $(document).ready(function() {
            geoGetCurrentLocation();

            $(":submit").click(function(event) {
                event.preventDefault(); //prevent the form from posting
                $("#outletResults").html("");

                var params = {
                    brand: $("#brandSelect").val(),
                    currentLatitude: currentLatitude,
                    currentLongitude: currentLongitude
                };
                const url = "/outlets";

                $.getJSON(url, params, function(data) {
                    var toDisplay = [];
                    if (data.outlets.length == 0) {
                        toDisplay.push("Could not find brand in DB.");
                    } else {
                        $.each(data.outlets, function(key, val) {
                            toDisplay.push( "<li id='" + key + "'>" + val.name + " (" + val.distance + ")</li>" );
                        });
                    }
                    $("<ul/>", {
                        html: toDisplay.join("")
                    }).appendTo("#outletResults");
                }).fail(function() {
                    console.error("failed");
                }).always(function() {
                    console.log("complete");
                });
            });
        });
    </script>
</body>
</html>
