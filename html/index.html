<!DOCTYPE html>
<html>
<head>
    <title>Near Me</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <form action="/outlets">
        <input type="text" name="searchWord" placeholder="Find this near me">
        <input type="submit" value="Go!">
    </form>
    <p id="locationStatus">Your location: </p>
    <script>
        let currentLatitude = null;
        let currentLongitude = null;

        function geoGetCurrentLocation() {
            const status = document.querySelector("#locationStatus");

            function success(pos) {
                currentLatitude = pos.coords.latitude;
                currentLongitude = pos.coords.longitude;
                status.textContent += currentLatitude + " " + currentLongitude;
            }

            function error() {
                status.textContent += "Error (unable to retrieve)";
            }

            if (!navigator.geolocation) {
                status.textContent += "Error (geolocation not supported)";
            } else {
                console.log('Trying to get location');
                navigator.geolocation.getCurrentPosition(success, error);
            }
        }

        // Endpoint: http://localhost:3000/outlets?searchWord=kfc&currentLatitude=1.3730702&currentLongitude=103.9028103
        // NOTE: code not working
        // 1) Able to complete getJSON request, but the url being visited is still /outlets?searchWord=kfc. Form action attribute value?
        // 2) Failed to find a way to call geoGetCurrentLocation() so that actual Lat Long (not hardcoded) can be sent as the query params.
        $(document).ready(function() {
            geoGetCurrentLocation();

            $(":submit").click(function() {
                var params = {
                    searchWord: $("input[name=searchWord]").val(),
                    currentLatitude: currentLatitude,
                    currentLongitude: currentLongitude
                };
                const url = new URL("http://localhost:3000/outlets");
                $.each(params, function(key, val){
                    url.searchParams.append(key, val);
                });

                $.getJSON(url, function(data) {
                    // alert(url); //correct url, built url is ready at this time
                    // alert("requesting");
                    var toDisplay = [];
                    $.each(data.outlets, function(key, val) {
                        toDisplay.push( "<li id='" + key + "'>" + val.name + " (" + val.distance + ")</li>" );
                    });
                    $("<ul/>", {
                        html: toDisplay.join("")
                    }).appendTo("body");
                }).fail(function() {
                    // alert("failed");
                }).always(function() {
                    // alert("complete");
                });

                event.preventDefault(); //prevent the form from posting
            });
        });
        
        // $("form[name=myForm]").submit(function(event) {
        //     alert("submitted");

        //     $.ajax({
        //         url: "http://localhost:3000/outlets",
        //         data: {searchWord: $("input[name=searchWord]").val()},
        //         type: "POST"
        //     })
        //     .promise()
        //     .then(function(data){
        //         console.log(data);
        //     });

        //     event.preventDefault();
        // });
    </script>
</body>
</html>
